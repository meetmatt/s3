<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Amazon S3 by meetmatt</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Amazon S3</h1>
        <h2>Документация и инструменты для переноса файлов на Amazon S3</h2>
        <a href="https://github.com/meetmatt/s3" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <p><a href="index.html">Оглавление</a> | <a href="proxy.html" title="Настройка прокси">Далее</a></p>

<h1>
<a name="%D0%9F%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0" class="anchor" href="#%D0%9F%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0"><span class="octicon octicon-link"></span></a>Подготовка</h1>

<p>Все шаги перечисленные ниже производятся в панели управления <a href="https://console.aws.amazon.com">Amazon Web Services</a>.</p>

<h2>
<a name="s3" class="anchor" href="#s3"><span class="octicon octicon-link"></span></a>S3</h2>

<h3>
<a name="%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B1%D0%B0%D0%BA%D0%B5%D1%82%D0%B0" class="anchor" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B1%D0%B0%D0%BA%D0%B5%D1%82%D0%B0"><span class="octicon octicon-link"></span></a>Создание бакета</h3>

<p>Заходим в консоль Амазона, переходим в настройки S3.</p>

<p>Чтобы создать бакет нажимаем на <code>Create Bucket</code>:</p>

<p><img src="images/01.png" alt="Create Bucket" title="Create Bucket"></p>

<p>В открывшемся окне вводим название бакета и выбираем регион <code>Ireland</code> (он ближе всего к нашим серверам).</p>

<p><img src="images/02.png" alt="New Bucket" title="New Bucket"></p>

<p>Имя бакета должно быть уникальным, в соответствии с ним создается поддомен вида <code>bucketname.s3.amazonaws.com</code>, по которому будут доступны наши файлы. Жмем <code>Create</code>.</p>

<p>Если имя бакета не уникально, то будет выведена ошибка.</p>

<p>После создания новый бакет появится в списке слева.</p>

<h3>
<a name="%D0%9E%D1%82%D0%BA%D1%80%D1%8B%D1%82%D0%B8%D0%B5-%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D1%87%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B0-%D0%BD%D0%B0-%D1%87%D1%82%D0%B5%D0%BD%D0%B8%D0%B5" class="anchor" href="#%D0%9E%D1%82%D0%BA%D1%80%D1%8B%D1%82%D0%B8%D0%B5-%D0%BF%D1%83%D0%B1%D0%BB%D0%B8%D1%87%D0%BD%D0%BE%D0%B3%D0%BE-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B0-%D0%BD%D0%B0-%D1%87%D1%82%D0%B5%D0%BD%D0%B8%D0%B5"><span class="octicon octicon-link"></span></a>Открытие публичного доступа на чтение</h3>

<p>Чтобы файлы, находящиеся в бакете были публично доступны по прямой ссылке необходимо добавить глобальное разрешение в меню <code>Properties</code> выбранного бакета.</p>

<p><img src="images/03.png" alt="Bucket Permissions" title="Bucket Permissions"></p>

<p>По умолчанию авторизованному супер-пользователю доступны все действия с бакетом и объектами в нем.</p>

<p><img src="images/04.png" alt="Bucket Permissions" title="Bucket Permissions"></p>

<p>Чтобы добавить разрешение на чтение файлов для анонимных пользователей выбираем <code>Add more permissions</code>, в поле <code>Grantee</code> выставляем <code>Everyone</code> и ставим флаг <code>View Permissions</code>. Сохраняем изменения.</p>

<p><img src="images/05.png" alt="Grant Everyone View Permissions" title="Allow everyone to view bucket"></p>

<h2>
<a name="%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B0" class="anchor" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%B0"><span class="octicon octicon-link"></span></a>Настройка доступа</h2>

<p>Для того чтобы работать с API Amazon Web Services необходимо создать группу, выставить групповые права, создать пользователя и добавить его в группу.</p>

<p>Для управления пользователями в Amazon используется сервис <code>Identity and Access Management</code> (IAM).</p>

<p><img src="images/06.png" alt="Identity and Access Management" title="Identity and Access Management"></p>

<h3>
<a name="%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%8B" class="anchor" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%8B"><span class="octicon octicon-link"></span></a>Создание группы</h3>

<p>Создаем группу перейдя в панель управления группами IAM и нажав <code>Create New Group</code>.</p>

<p><img src="images/07.png" alt="IAM Groups" title="IAM Groups"></p>

<p>Вводим имя группы.</p>

<p><img src="images/08.png" alt="Group name" title="Group name"></p>

<p>Далее необходимо указать, какие действия и над какими объектами разрешены пользователям группы.</p>

<p>Нам потребуются разрешения на получение списка файлов, чтение, загрузку, удаление и изменение прав файлов.</p>

<p>Этим требованиям соответствуют права:</p>

<ul>
<li>ListBucket<br>
</li>
<li>GetObject<br>
</li>
<li>PutObject<br>
</li>
<li>DeleteObject<br>
</li>
<li>GetObjectAcl<br>
</li>
<li>PutObjectAcl<br>
</li>
</ul><p>Чтобы сгенерировать файл с правами, выбираем пункт <code>Policy Generator</code>.</p>

<p><img src="images/09.png" alt="Policy Generator" title="Policy generator"></p>

<p>Указываем сервис <code>Amazon S3</code> и выбираем указанные выше действия в списке <code>Actions</code>.</p>

<p>В поле <code>Amazon Resource Name (ARN)</code> нужно указать путь до ресурса, в нашем случае это бакет S3.</p>

<p>Название ресурса указывается в формате <code>arn:aws:SERVICE_NAME:::RESOURCE_NAME</code>,
соответсвенно SERVICE_NAME - s3, а RESOURCE_NAME - название бакета, выбранное при создании.</p>

<p>Допустим бакет называется <em>mybucket</em>, в таком случае ARN будет <em>arn:aws:s3:::mybucket</em>.</p>

<p><img src="images/10.png" alt="Policy Generator Settings" title="Policy Generator Settings"></p>

<p>В результате сгенерируется файл с правами, но нам необходимо добавить одну строчку, чтобы все заработало.</p>

<p><img src="images/11.png" alt="Generated policy" title="Generated policy"></p>

<p>В разделе <code>Resource</code> необходимо продублировать строчку с ресурсом <code>"arn:aws:s3:::RESOURCE_NAME"</code>, но добавив в конце <code>/*</code>. Таким образом указанные права будут распространяться не только на сам ресурс (бакет S3 в нашем случае), но так же и на все его содержимое (файлы). В итоге у нас должно быть два ресурса - <code>"arn:aws:s3:::RESOURCE_NAME"</code> и <code>"arn:aws:s3:::RESOURCE_NAME/*"</code>, где RESOURCE_NAME - название нашего бакета.</p>

<h3>
<a name="%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F" class="anchor" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F"><span class="octicon octicon-link"></span></a>Создание пользователя</h3>

<p>Переходим в раздел управления пользователями и нажимаем <code>Create New Users</code>.</p>

<p><img src="images/12.png" alt="IAM Users" title="IAM Users"></p>

<p>Вводим имя пользователя, убеждаемся что стоит флаг <code>Generate an access key for each user</code> и нажимаем <code>Create</code>.</p>

<p><img src="images/13.png" alt="Create User" title="Create User"></p>

<p>В скрытом поле указаны два ключа - <code>Access Key ID</code> и <code>Secret Access Key</code>. По сути это логин и пароль для работы с API. Сохраняем их в надежном месте.</p>

<p><img src="images/14.png" alt="API Credentials" title="API Credentials"></p>

<h3>
<a name="%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F-%D0%B2-%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%83" class="anchor" href="#%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F-%D0%B2-%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%83"><span class="octicon octicon-link"></span></a>Добавление пользователя в группу</h3>

<p>Выбираем созданного пользователя и добавляем его в группу.</p>

<p><img src="images/15.png" alt="Add user to groups" title="Add user to groups"></p>

<p><img src="images/16.png" alt="Select group" title="Select group"></p>

<h2>
<a name="cloudfront" class="anchor" href="#cloudfront"><span class="octicon octicon-link"></span></a>CloudFront</h2>

<h3>
<a name="%D0%A1%D1%85%D0%B5%D0%BC%D0%B0-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B" class="anchor" href="#%D0%A1%D1%85%D0%B5%D0%BC%D0%B0-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B"><span class="octicon octicon-link"></span></a>Схема работы</h3>

<p>CloudFront - это CDN от Amazon'а. По сути это географически распределенный файловый кеш. </p>

<p>Схема его работы следующая.</p>

<p>Исходный файл существует в единственном экземпляре и хранится в бакете S3, например в Ирландии. В свою очередь у нас настроен CloudFront с серверами в Северной Америке и Европе. В зависимости от того, где находится пользователь запрашивающий файл, он с помощью geo DNS попадает на ближайший к нему сервер CloudFront'а. Сервер сначала ищет файл в своем кеше, и если он находится (cache hit), то сразу отдает его пользователю. В случае, если файла в кеше нет (cache miss), то CloudFront идет к источнику (origin), в нашем случае это бакет S3, скачивает и сохраняет в кеш.</p>

<p>Соответственно вместо ссылки на файл в бакете (<code>http://mybucket.s3.amazonaws.com/boobs.jpg</code>) мы должны давать пользователю ссылку на CloudFront (<code>http://adns8979ascnvhasd3.cloudfront.com/boobs.jpg</code>).</p>

<h3>
<a name="%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8" class="anchor" href="#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8"><span class="octicon octicon-link"></span></a>Создание дистрибуции</h3>

<p>Переходим в панель управления CloudFront.</p>

<p><img src="images/17.png" alt="CloudFront" title="CloudFront"></p>

<p>Создаем дистрибуцию.</p>

<p><img src="images/18.png" alt="Create Distribution" title="Create Distribution"></p>

<p>Выбираем тип <code>Web</code>.</p>

<p><img src="images/19.png" alt="Web Distribution" title="Web Distribution"></p>

<p>В разделе <code>Origin Settings</code> указывается источник, где лежат исходные файлы.</p>

<p>В выпадающем списке <code>Origin Domain Name</code> выбираем созданный нами бакет вида <code>BUCKET_NAME.s3.amazonaws.com</code>.</p>

<p>Значение в поле <code>Origin ID</code> будет сгенерировано автоматически.</p>

<p><img src="images/20.png" alt="Origin Settings" title="Origin Settings"></p>

<p>Оставляем все по дефолту кроме поля <code>Price Class</code> в разделе <code>Distribution Settings</code>.</p>

<p><img src="images/21.png" alt="Distribution Settings Price Class" title="Distribution Settings Price Class"></p>

<p>В зависимости от требований можно выбрать в скольких регионах будут находится CDN серверы, соответственно чем больше серверов, тем выше плата за использование. Чтобы сократить стоимость укажем <code>Use Only US and Europe</code>. Если выбрать <code>Use All Edge Locations</code>, то наши файлы будут кешироваться на всех континентах. Полный список регионов указан <a href="http://aws.amazon.com/cloudfront/details/">здесь</a>.</p>

<p>В поле <code>Alternate Domain Names (CNAMEs)</code> можно указать свой красивый домен, который будет использоваться в публичных ссылках на файлы, например <code>cdn.example.com</code>. Об этом чуть позже.</p>

<p>Создаем дистрибуцию нажав <code>Create Distribution</code>.</p>

<p>В списке мы видим, что наша дистрибуция находится в статусе <code>In Progress</code>. Когда статус будет <code>Deployed</code> мы сможем протестировать работу.</p>

<p><img src="images/22.png" alt="Distributions" title="Distributions"></p>

<h3>
<a name="%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BD%D0%B0%D1%88%D0%B5%D0%B3%D0%BE-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B2-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D1%8E" class="anchor" href="#%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BD%D0%B0%D1%88%D0%B5%D0%B3%D0%BE-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B2-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D1%8E"><span class="octicon octicon-link"></span></a>Добавление нашего сервера в дистрибуцию</h3>

<p>Дистрибуцию нужно настроить таким образом, чтобы CloudFront в случае, если файла по какой-то причине еще нет на S3, брал его с нашего исходного сервера.</p>

<p>Для этого выберем созданную дистрибуцию и отредактируем настройки нажав <code>Distribution Settings</code>.</p>

<p>Во вкладке <code>General</code> указан созданный для дистрибуции домен вида <code>xxxxxxxx.cloudfront.com</code> (поле <code>Domain Name</code>).</p>

<p><img src="images/23.png" alt="General Distribution Settings" title="General Distribution Settings"></p>

<p>Список исходных серверов настраивается в вкладке <code>Origins</code>.</p>

<p><img src="images/24.png" alt="Distribution Origins" title="Distribution Origins"></p>

<p>Добавим наш сервер в качестве исходного.</p>

<p><img src="images/25.png" alt="Create Origin" title="Create Origin"></p>

<p>В поле <code>Origin Domain Name</code> указываем домен, по которому доступен наш сервер. Поле <code>Origin ID</code> подставится автоматически. Сохраняем нажав <code>Create</code>.</p>

<p>Во вкладке <code>Behaviors</code> указаны правила, по которым CloudFront будет искать файл, если его нет в кеше. Создадим новое правило для нашего сервера.</p>

<p><img src="images/26.png" alt="Distribution Behaviors" title="Distribution Behaviors"></p>

<p>Поле <code>Path Pattern</code> определяет маску файла для правила. В нашем случае интересуют все файлы, поэтому указываем <code>*</code>.</p>

<p><img src="images/27.png" alt="Create Distribution Behavior" title="Create Distribution Behavior"></p>

<p>Это фича нужна, когда например у нас файлы .css лежат не на том же сервере, где картинки .jpg Тогда для одного сервера указываем правило *.css, для другого *.jpg. Подробнее про формат маски можно почитать <a href="http://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesPathPattern">здесь</a>.</p>

<p>В выпадающем списке <code>Origin</code> выбираем добавленный на предыдущем шаге сервер.</p>

<p>Сохраняем конфигурацию и переходим к тестированию.</p>

<h2>
<a name="%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8" class="anchor" href="#%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8"><span class="octicon octicon-link"></span></a>Тестирование конфигурации</h2>

<h3>
<a name="s3cloudfront" class="anchor" href="#s3cloudfront"><span class="octicon octicon-link"></span></a>S3+CloudFront</h3>

<p>Для начала проверим, что правильно настроена связка S3+CloudFront.</p>

<p>Переходим в панель управления S3, в левом меню выбираем созданный нами бакет, в выпадающем меню <code>Actions</code> выбираем <code>Upload</code>.</p>

<p><img src="images/28.png" alt="Upload file to S3" title="Upload file to S3"></p>

<p>Добавляем файл <code>Add Files</code>.</p>

<p><img src="images/29.png" alt="Add Files" title="Add Files"></p>

<p>Переходим во вкладку <code>Set Details</code> и далее в <code>Set Permissions</code> и выставляем флаг <code>Make everything public</code>, загружаем <code>Start Upload</code>.</p>

<p><img src="images/30.png" alt="Make Public" title="Make Public"></p>

<p>Проверяем, что файл доступен по прямой ссылке на S3 <code>http://BUCKET_NAME.s3.amazonaws.com/elephpant.png</code>, где BUCKET_NAME - название бакета.</p>

<p>Дальше проверяем, что файл доступен по ссылке на CloudFront <code>xxxxxxxxxxx.cloudfront.net/elephpant.png</code>.</p>

<p>Этот тест провалится, потому что у нас еще не настроен прокси. Об этом в <a href="proxy.md">следующем разделе</a>.</p>

<p><a href="index.html">Оглавление</a> | <a href="proxy.html" title="Настройка прокси">Далее</a></p>

<p><a href="index.html">Оглавление</a> | <a href="setup.html" title="Подготовка">Назад</a> | <a href="tools.html" title="Инструменты">Далее</a></p>

<h1>
<a name="%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8" class="anchor" href="#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8"><span class="octicon octicon-link"></span></a>Настройка прокси</h1>

<p>В ситуации, когда файл находится на S3, но уже не доступен на нашем сервере, CloudFront, проверив файл на нашем сервере, сразу вернет 404 ошибку и не пойдет искать его на S3.</p>

<p>Этого можно избежать, проверяя в коде существование файла локально, и генерируя ссылку соответственно либо на наш сервер, либо на CDN. Но это потребует объемных изменений.</p>

<p>Чтобы избежать эту проблему, нужно прописать http proxy на нашем сервере.</p>

<h2>
<a name="nginx-proxy" class="anchor" href="#nginx-proxy"><span class="octicon octicon-link"></span></a>Nginx proxy</h2>

<p>Нам необходимо, чтобы nginx сначала пытался взять файл локально, а в случае, если файла нет, проксировал запрос на S3.</p>

<p>Для этого укажем путь до прокси в конфиге nginx'а в секции server:</p>

<pre><code>http {

    #...

    server {
        listen 80;
        server_name example.com www.example.com;

        # вместо images надо указать директорию, файлы из которой переносятся на S3
        location ~ ^/images/(.*)$ {
            # сначала файл берется локально и, если он не найден, выполняется директива s3
            try_files $uri @s3;
        }

        # выполняется только если файл не найден
        location @s3 {

            # вместо example надо указать название реального бакета
            set $s3_host 'example.s3.amazonaws.com';
            set $s3_file '$1';

            # для корректной работы необходимо выставить заголовки
            proxy_set_header       Host $s3_host;
            proxy_set_header       Authorization '';
            proxy_hide_header      x-amz-id-2;
            proxy_hide_header      x-amz-request-id;
            proxy_hide_header      Set-Cookie;
            proxy_ignore_headers   "Set-Cookie";
            proxy_buffering        off;
            proxy_intercept_errors on;
            proxy_redirect off;

            proxy_pass             http://$s3_bucket/images/$s3_file;
        }

        # остальные директивы location
    }
}
</code></pre>

<p>Перезапускаем конфигурацию nginx'а:</p>

<pre><code>$ service nginx reload
</code></pre>

<h2>
<a name="%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0" class="anchor" href="#%D0%9F%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B0"><span class="octicon octicon-link"></span></a>Проверка</h2>

<p>Заходим в консоль управления S3. В нашем бакете создаем папку images. В нее загружаем файл, которого точно нет на нашем сервере в директории images. Открываем файл по ссылке на CloudFront. Файл должен открыться.</p>

<p>В этот момент CloudFront ищет файл в своем кеше, не обнаруживает его в кеше, посылает запрос на наш сервер, nginx ищет файл локально, не обнаруживает его, отправляет запрос на S3, получает файл и отправляет его обратно CloudFront'у, тот его кеширует и отдает клиенту.</p>

<p>Справедливости ради стоит заметить, что у этой схемы есть очевидный минус - наш сервер отправляет запрос на S3, чтобы забрать файл. Но делает он это только один раз, потому что все следующие разы клиенты получат ответ из кеша CloudFront'а.</p>

<p>Если мы посмотрим в веб-инспектор, то увидим специальный заголовок <code>X-Cache</code>, в котором CloudFront указывает, откуда загружен файл - из кеша или из источника. Первый раз файл всегда берется из источника (<code>X-Cache: Miss from cloudfront</code>). Перезагрузив страницу в этом заголовке будет значение <code>X-Cache: Hit from cloudfront</code>.</p>

<h2>
<a name="%D0%9F%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B2%D0%BC%D0%B5%D1%81%D1%82%D0%BE-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8" class="anchor" href="#%D0%9F%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B2%D0%BC%D0%B5%D1%81%D1%82%D0%BE-%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8"><span class="octicon octicon-link"></span></a>Перенаправление вместо прокси</h2>

<p>Чтобы сократить издержки на проксирование запроса от CloudFront'а до S3 и обратно, можно просто перенаправлять запрос. Конфиг в таком случае выглядит так:</p>

<pre><code>http {

    #...

    server {
        listen 80;
        server_name example.com www.example.com;

        location ~ ^/images/(.*)$ {
            try_files $uri @s3redirect;
        }

        location @s3redirect {
            return 301 http://example.s3.amazonaws.com/images/$1;       }

        # остальные директивы location
    }
}
</code></pre>

<p>В случае, если файл не найден, nginx ответит CloudFront'у редиректом (301 Moved permanently), CloudFront в свою очередь перенаправит клиента по новому URL'у.</p>

<p>Плюс - мы не тратим траффик на отправку файла CloudFront'у.</p>

<p>Минус - CloudFront закеширует не сам файл, а редирект на него, соответственно клиент получит файл прямиком с S3, который находится в единственном регионе, траффик с S3 дороже и скорость обычно медленнее. Вероятно что это конфигурация в результате окажется дороже, чем использование прокси.</p>

<p><a href="index.html">Оглавление</a> | <a href="setup.md" title="Подготовка">Назад</a> | <a href="tools.md" title="Инструменты">Далее</a></p>

<p><a href="index.html">Оглавление</a> | <a href="proxy.html" title="Настройка прокси">Назад</a> | <a href="php.html" title="Реализация на PHP">Далее</a></p>

<h1>
<a name="%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B-%D0%B8-%D0%B1%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8-%D0%B4%D0%BB%D1%8F-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D1%81-s3" class="anchor" href="#%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B-%D0%B8-%D0%B1%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8-%D0%B4%D0%BB%D1%8F-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D1%81-s3"><span class="octicon octicon-link"></span></a>Инструменты и библиотеки для работы с S3</h1>

<h2>
<a name="%D0%93%D1%80%D0%B0%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D1%83%D1%82%D0%B8%D0%BB%D0%B8%D1%82%D1%8B" class="anchor" href="#%D0%93%D1%80%D0%B0%D1%84%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D1%83%D1%82%D0%B8%D0%BB%D0%B8%D1%82%D1%8B"><span class="octicon octicon-link"></span></a>Графические утилиты</h2>

<h3>
<a name="cyberduck" class="anchor" href="#cyberduck"><span class="octicon octicon-link"></span></a>Cyberduck</h3>

<p>Легкая бесплатная программа для Windows и Mac OS X.</p>

<p><a href="https://cyberduck.io/">https://cyberduck.io/</a></p>

<p><img src="images/32.png" alt='"Cyberduck"' title="Cyberduck"></p>

<p>Создаем <code>Новое подключение</code>, выбираем <code>S3</code>, вводим полный путь до бакета в формате <code>bucket.s3.amazonaws.com</code>, в качестве имени пользователя вводим <code>Access Key ID</code>, в качестве пароля <code>Secret Access Key</code>, полученные на этапе <a href="setup.md">подготовки</a>.</p>

<h2>
<a name="%D0%91%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8" class="anchor" href="#%D0%91%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8"><span class="octicon octicon-link"></span></a>Библиотеки</h2>

<h3>
<a name="python" class="anchor" href="#python"><span class="octicon octicon-link"></span></a>Python</h3>

<h4>
<a name="boto" class="anchor" href="#boto"><span class="octicon octicon-link"></span></a>Boto</h4>

<p>Boto - библиотека на Python предоставляющая интерфейс для Amazon Web Services.</p>

<p>Публичный репозиторий - <a href="https://github.com/boto/boto">https://github.com/boto/boto</a></p>

<p>Документация - <a href="http://docs.pythonboto.org/en/latest">http://docs.pythonboto.org/en/latest</a></p>

<p>Единственное требование - Python 2.6/2.7, частично поддерживвается Python 3.3/3.4.</p>

<p>Устанавливается Boto с помощью питоновского менеджера пакетов <a href="https://pip.pypa.io/en/latest/index.html">pip</a>.</p>

<h5>
<a name="%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-pip" class="anchor" href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-pip"><span class="octicon octicon-link"></span></a>Установка pip</h5>

<p><strong>Aptitude (Debian and Ubuntu)</strong></p>

<pre><code>$ sudo apt-get install python-pip
</code></pre>

<p><strong>Yum (CentOS, Fedora)</strong></p>

<pre><code>$ sudo yum install python-pip
</code></pre>

<p><strong>FreeBSD</strong></p>

<pre><code>$ cd /usr/ports/devel/py-pip/ &amp;&amp; make install clean
</code></pre>

<h5>
<a name="%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%B0%D0%B2%D0%BA%D0%B0-boto" class="anchor" href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%B0%D0%B2%D0%BA%D0%B0-boto"><span class="octicon octicon-link"></span></a>Устанавка boto</h5>

<pre><code>$ pip install boto
</code></pre>

<h3>
<a name="php" class="anchor" href="#php"><span class="octicon octicon-link"></span></a>PHP</h3>

<h4>
<a name="amazon-web-services-sdk" class="anchor" href="#amazon-web-services-sdk"><span class="octicon octicon-link"></span></a>Amazon Web Services SDK</h4>

<h2>
<a name="%D0%9A%D0%BE%D0%BD%D1%81%D0%BE%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%83%D1%82%D0%B8%D0%BB%D0%B8%D1%82%D1%8B" class="anchor" href="#%D0%9A%D0%BE%D0%BD%D1%81%D0%BE%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%83%D1%82%D0%B8%D0%BB%D0%B8%D1%82%D1%8B"><span class="octicon octicon-link"></span></a>Консольные утилиты</h2>

<h3>
<a name="s3put" class="anchor" href="#s3put"><span class="octicon octicon-link"></span></a>s3put</h3>

<p>Коносльная утилита для закачки файлов на S3 на Python; поставляется вместе с Boto.</p>

<p>Мы ее будем использовать для переноса файлов с сервера на S3.</p>

<h4>
<a name="%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0" class="anchor" href="#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0"><span class="octicon octicon-link"></span></a>Установка</h4>

<p>Тулзу можно использовать сразу после установки boto.</p>

<p>Но нам необходимо не только копировать файлы на S3, но и удалять их. Текущая релизация этого не умеет, поэтому надо заменить ее <a href="https://github.com/meetmatt/s3put/blob/master/bin/s3put">моей версией</a>.</p>

<p>Сначала убедимся, что исходный s3put лежит в <code>/usr/local/bin</code>. Если все окей, то заменяем его моим:</p>

<pre><code>$ cd /usr/local/bin
$ sudo cp s3put s3put.backup
$ sudo wget https://raw.githubusercontent.com/meetmatt/s3put/master/s3put.py -O s3put
$ sudo chmod +x s3put
</code></pre>

<p>Проверяем:</p>

<pre><code>$ s3put | grep delete
          [--header] [--region &lt;name&gt;] [-x/--delete] [--host &lt;s3_host&gt;] path [path...]
        delete - delete local file after successfull upload 

</code></pre>

<h4>
<a name="%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5" class="anchor" href="#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5"><span class="octicon octicon-link"></span></a>Использование</h4>

<p>Нас интересуют параметры:</p>

<ul>
<li>
<strong>-a/--access_key</strong> - Access Key ID</li>
<li>
<strong>-s/--secret_key</strong> - Secret Access Key</li>
<li>
<strong>-b/--bucket</strong> - название бакета</li>
<li>
<strong>--region</strong> - сокращенное название региона (колонка <em>Region</em> в <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region">таблице</a>)</li>
<li>
<strong>--delete</strong> - удалить файлы после загрузки</li>
<li>
<strong>--grant</strong> - изменить ACL файла</li>
<li>
<strong>--prefix</strong> - префикс, который будет удален из пути файла</li>
</ul><p>Допустим мы хотим переместить фотографии юзеров из папки <code>/var/www/site/public/uploads/images</code>.</p>

<p>Ссылка на файл сейчас выглядит так: <code>http://example.com/uploads/images/boobs.jpg</code>.</p>

<p>Нам надо, чтобы файл был доступен по ссылке <code>http://example.s3.amazonaws.com/uploads/images/boobs.jpg</code>.</p>

<p>Тогда в качестве параметра <code>prefix</code> должно быть указано <code>/var/www/site/public/</code>.</p>

<p>Так выглядит вызов s3put в нашем случае:</p>

<pre><code>$ s3put --access-key LUGMNMH7B372CDN1F654 \  
        --secret-key oUkLK/9SAsU9uYwQV4oO+9iLPO3bwyVbz6yBEaaY \  
        --bucket example \  
        --region='eu-west-1' \  
        --grant='public-read' \  
        --prefix='/var/www/site/public/' \  
        --delete \  
        /var/www/site/public/uploads/images/
</code></pre>

<p>В случае CloudFront файл будет доступен по ссылке <code>http://xxxxxxx.cloudfront.com/uploads/images/boobs.jpg</code>.</p>

<p>Если указать путь до файла, то скопируется только он, если до директории, то рекурсивно скопируются все файлы и поддиректории в ней.</p>

<h4>
<a name="%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F" class="anchor" href="#%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F"><span class="octicon octicon-link"></span></a>Пример использования</h4>

<p>Скачаем какой-нибудь файл во временную директорию (здесь и далее используется Linux):</p>

<pre><code>$ mkdir -p /tmp/public/uploads/images
$ wget http://a0.awsstatic.com/main/images/logos/aws_logo.png -O /tmp/public/uploads/images/boobs.png
</code></pre>

<p>Узнаем размер файла, чтобы потом сравнить с тем, что попадет на S3:</p>

<pre><code>$ ls -nl /tmp/public/uploads/images/aws_logo.png | awk '{print $5}'
6258
</code></pre>

<p>Переместим файл на S3:</p>

<pre><code>$ s3put --a LUGMNMH7B372CDN1F654 -s oUkLK/9SAsU9uYwQV4oO+9iLPO3bwyVbz6yBEaaY -b example --region='eu-west-1' --grant='public-read' --prefix='/tmp/public/' --delete /tmp/public/uploads/images/
Copying /tmp/public/uploads/images/aws_logo.png to example/uploads/images/aws_logo.png
Upload complete
Removing /tmp/public/uploads/images/aws_logo.png
</code></pre>

<p>Если s3put выдает ошибку <code>RequestTimeTooSkewed</code>, значит серверное время слишком расходится с временем Амазона. Синхронизируем часы по NTP:</p>

<pre><code>$ sudo ntpdate 0.pool.ntp.org
</code></pre>

<p>Проверим, что файл был удален:</p>

<pre><code>$ ls -l /tmp/public/uploads/images/
total 0
</code></pre>

<p>Проверим размер файла на S3:</p>

<pre><code>$ curl -I http://example.s3.amazonaws.com/uploads/images/aws_logo.png 2&gt;&amp;1 | grep Content-Length | awk '{print $2}'
6258
</code></pre>

<p>Вместо последнего шага можно просто открыть картинку в браузере <code>http://example.s3.amazonaws.com/uploads/images/aws_logo.png</code> или в Cyberduck.</p>

<p><a href="index.html">Оглавление</a> | <a href="proxy.md" title="Настройка прокси">Назад</a> | <a href="php.md" title="Реализация на PHP">Далее</a></p>

<p><a href="index.html">Оглавление</a> | <a href="tools.html" title="Инструменты">Назад</a> | <a href="cron.html" title="Cron скрипт">Далее</a></p>

<h1>
<a name="%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%BD%D0%B0-php" class="anchor" href="#%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%BD%D0%B0-php"><span class="octicon octicon-link"></span></a>Реализация на PHP</h1>

<p><a href="index.html">Оглавление</a> | <a href="tools.html" title="Инструменты">Назад</a> | <a href="cron.html" title="Cron скрипт">Далее</a></p>

<p><a href="index.html">Оглавление</a> | <a href="php.html" title="Реализация на PHP">Назад</a></p>

<h1>
<a name="cron-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82" class="anchor" href="#cron-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82"><span class="octicon octicon-link"></span></a>Cron скрипт</h1>

<p><a href="index.html">Оглавление</a> | <a href="php.html" title="Реализация на PHP">Назад</a> </p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/meetmatt/s3/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/meetmatt/s3/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/meetmatt/s3"></a> is maintained by <a href="https://github.com/meetmatt">meetmatt</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>